---
- name: Make sure the directory exists
  ansible.builtin.file:
    path: /tmp/flux
    state: directory
    mode: "0755"
- name: Remove downloaded flux install script
  ansible.builtin.file:
    path: /tmp/flux/flux-install-v{{ flux.version }}.sh
    state: absent
- name: Download flux install script
  ansible.builtin.get_url:
    url: https://fluxcd.io/install.sh
    dest: /tmp/flux/flux-install-v{{ flux.version }}.sh
    mode: "0755"
  environment:
    FLUX_VERSION: "{{ flux.version }}"
- name: Remove existing flux binary
  ansible.builtin.file:
    path: /usr/local/bin/flux
    state: absent
- name: Run flux install script
  ansible.builtin.command: /tmp/flux/flux-install-v{{ flux.version }}.sh
  args:
    creates: /usr/local/bin/flux
