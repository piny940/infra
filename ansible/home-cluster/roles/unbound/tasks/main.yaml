---
- name: Install Unbound
  ansible.builtin.apt:
    name:
      - unbound
    state: present
    update_cache: true

- name: Disable systemd-resolved DNS stub listener
  ansible.builtin.lineinfile:
    path: /etc/systemd/resolved.conf
    regexp: "^#?DNSStubListener="
    line: "DNSStubListener=no"
    state: present
  register: resolved_conf_changed
- name: Restart systemd-resolved
  ansible.builtin.systemd:
    name: systemd-resolved
    state: restarted
  when: resolved_conf_changed.changed

- name: Create Unbound configuration directory
  ansible.builtin.file:
    path: /etc/unbound/unbound.conf.d
    state: directory
    owner: root
    group: root
    mode: "0755"

- name: Deploy main Unbound configuration
  ansible.builtin.template:
    src: unbound.conf.j2
    dest: /etc/unbound/unbound.conf.d/home-network.conf
    owner: root
    group: root
    mode: "0644"
  notify:
    - Restart Unbound

- name: Remove existing /etc/resolv.conf
  ansible.builtin.file:
    path: /etc/resolv.conf
    state: absent
- name: Update /etc/resolv.conf to use Unbound
  ansible.builtin.copy:
    content: |
      # Generated by Ansible - Unbound DNS
      nameserver 127.0.0.1
      options edns0
    dest: /etc/resolv.conf
    owner: root
    group: root
    mode: "0644"

- name: Enable and start Unbound service
  ansible.builtin.systemd:
    name: unbound
    enabled: true
    state: started
