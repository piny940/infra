name: Staging Deploy
on:
  pull_request:
  push:
    branches:
      - main

permissions:
  id-token: write
  contents: read
  pull-requests: read
  packages: write

jobs:
  filter:
    runs-on: ubuntu-latest
    outputs:
      kube: ${{ steps.path-filter.outputs.kube }}
      svcmtr: ${{ steps.path-filter.outputs.svcmtr }}
      tf: ${{ steps.path-filter.outputs.tf }}
      fluxupd: ${{ steps.path-filter.outputs.fluxupd }}
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/bot-filter
        id: bot-filter
        with:
          actor: ${{ github.actor }}
      - uses: dorny/paths-filter@v3
        if: steps.bot-filter.outputs.is-bot == 'false'
        id: path-filter
        with:
          filters: |
            kube:
              - "kubernetes/**"
              - ".github/workflows/stg-deploy.yaml"
            svcmtr:
              - "service-monitor/**"
              - ".github/workflows/stg-deploy.yaml"
            tf:
              - "terraform/**"
              - ".github/workflows/stg-deploy.yaml"
            fluxupd:
              - "flux-target-updater/**"
              - ".github/workflows/stg-deploy.yaml"

  kube:
    runs-on: ubuntu-latest
    needs: filter
    environment: staging # 管理者の承認を必要とする
    if: needs.filter.outputs.kube == 'true' && github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v4
      - name: Deploy
        uses: ./.github/actions/kube-deploy-stg
        with:
          slack-bot-token: ${{ secrets.SLACK_NOTIFIER_TOKEN }}
          slack-channel-id: ${{ vars.STG_SLACK_CHANNEL_ID }}
          target-branch: ${{ github.head_ref }}
          flux-target-updater-token: ${{ secrets.FLUX_TARGET_UPDATER_TOKEN }}
          action-link: ${{ github.event.pull_request.html_url }}
  kube-main:
    runs-on: ubuntu-latest
    needs: filter
    if: needs.filter.outputs.kube == 'true' && github.event_name == 'push' && github.ref_name == 'main'
    steps:
      - uses: actions/checkout@v4
      - name: Deploy
        uses: ./.github/actions/kube-deploy-stg
        with:
          slack-bot-token: ${{ secrets.SLACK_NOTIFIER_TOKEN }}
          slack-channel-id: ${{ vars.STG_SLACK_CHANNEL_ID }}
          target-branch: main
          flux-target-updater-token: ${{ secrets.FLUX_TARGET_UPDATER_TOKEN }}
          action-link: ${{ github.event.repository.html_url }}/commit/${{ github.sha }}

  service-monitor:
    runs-on: ubuntu-latest
    needs: filter
    if: needs.filter.outputs.svcmtr == 'true' && github.event_name == 'pull_request'
    environment: staging # 管理者の承認を必要とする
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Deploy
        uses: ./.github/actions/service-monitor-deploy
        with:
          func-name: stgCheckHealthiness
          region: ${{ secrets.AWS_REGION }}
          role-arn: ${{ secrets.AWS_UPDATE_HEALTH_CHECK_ARN }}
  service-monitor-main:
    runs-on: ubuntu-latest
    needs: filter
    if: needs.filter.outputs.svcmtr == 'true' && github.event_name == 'push' && github.ref_name == 'main'
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Deploy
        uses: ./.github/actions/service-monitor-deploy
        with:
          func-name: stgCheckHealthiness
          region: ${{ secrets.AWS_REGION }}
          role-arn: ${{ secrets.AWS_UPDATE_HEALTH_CHECK_ARN }}

  fluxupd:
    runs-on: ubuntu-latest
    needs: filter
    if: needs.filter.outputs.fluxupd == 'true'
    steps:
      - name: Get current datetime
        run: echo "TIMESTAMP=$(date +'%Y%m%d%H%M%S')" >> $GITHUB_ENV
      - name: Check out
        uses: actions/checkout@v4
      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Build and push Docker images
        uses: docker/build-push-action@v6
        with:
          push: true
          context: ./flux-target-updater
          file: ./flux-target-updater/Dockerfile
          tags: |
            ghcr.io/piny940/flux-target-updater:main-${{ github.sha }}-${{ env.TIMESTAMP }}

  tf-apply:
    runs-on: ubuntu-latest
    needs: filter
    if: needs.filter.outputs.tf == 'true' && github.event_name == 'pull_request'
    environment: staging # 管理者の承認を必要とする
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Terraform Apply
        uses: ./.github/actions/tf-apply
        with:
          env: staging
          gcp_project: ${{ vars.STG_GCP_PROJECT }}
          gcp_project_number: ${{ vars.STG_GCP_PROJECT_NUMBER }}
  tf-apply-main:
    runs-on: ubuntu-latest
    needs: filter
    if: needs.filter.outputs.tf == 'true' && github.event_name == 'push' && github.ref_name == 'main'
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Terraform Apply
        uses: ./.github/actions/tf-apply
        with:
          env: staging
          gcp_project: ${{ vars.STG_GCP_PROJECT }}
          gcp_project_number: ${{ vars.STG_GCP_PROJECT_NUMBER }}
