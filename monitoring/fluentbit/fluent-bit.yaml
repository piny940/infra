service:
  http_server: off
  log_file: /fluent-bit/log/fluent-bit.log 
  log_level: info
parsers:
  - name: grafana_logs
    format: json
    time_key: t
    time_format: '%Y-%m-%dT%H:%M:%S.%LZ'
    time_keep: true
  - name: fluentbit_logs
    format: regex
    regex: '^\[(?<time>[^\]]+)\] \[(?<level>[^\]]*)\] \[(?<logger>[^\]]*)\] (?<msg>.*)$'
    time_key: time
    time_format: '%Y/%m/%d %H:%M:%S'
    time_keep: true

pipeline:
  inputs:
    - name: tail
      read_from_head: true
      tag: fluentbit.logs
      path: /fluent-bit/log/fluent-bit.log
      db: /fluent-bit/db/fluent-bit.pos
      db.locking: true
      parser: fluentbit_logs
    - name: tail
      read_from_head: true
      tag: grafana.logs
      path: /grafana/logs/*.log
      db: /fluent-bit/db/grafana.pos
      db.locking: true
      parser: grafana_logs
  filters:
    - name: type_converter
      match: 'grafana.logs'
      int_key:
        - status status string

  outputs:
    - name: es
      compress: gzip
      match: 'fluentbit.logs'
      host: elasticsearch
      port: 9200
      tls: on
      tls.verify: off
      http_user: 'elastic'
      http_passwd: '${ELASTICSEARCH_PASSWORD}'
      logstash_format: true
      logstash_prefix: fluentbit.logs
      logstash_prefix_separator: '-'
      logstash_dateformat: '%Y.%m.%d'
      time_key: '@timestamp'
      time_key_format: '%Y-%m-%dT%H:%M:%S'
      time_key_nanos: false
      include_tag_key: true
      tag_key: '_tag'
      suppress_type_name: true
      trace_error: true
    - name: es
      compress: gzip
      match: 'grafana.logs'
      host: elasticsearch
      port: 9200
      tls: on
      tls.verify: off
      http_user: 'elastic'
      http_passwd: '${ELASTICSEARCH_PASSWORD}'
      logstash_format: true
      logstash_prefix: grafana.logs
      logstash_prefix_separator: '-'
      logstash_dateformat: '%Y.%m.%d'
      time_key: '@timestamp'
      time_key_format: '%Y-%m-%dT%H:%M:%S'
      time_key_nanos: false
      include_tag_key: true
      tag_key: '_tag'
      suppress_type_name: true
      trace_error: true
