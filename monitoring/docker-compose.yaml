services:
  grafana:
    container_name: grafana
    image: grafana/grafana:12.2.0
    environment:
      GF_PATHS_CONFIG: /etc/grafana/grafana.ini
      GF_PATHS_DATA: /var/lib/grafana/data
      GF_PATHS_LOGS: /var/log/grafana
      GF_PATHS_PLUGINS: /var/lib/grafana/plugins
      GF_PATHS_PROVISIONING: /etc/grafana/provisioning
    env_file:
      - ./grafana/.env
    volumes:
      - grafana-storage:/var/lib/grafana
      - grafana-logs:/var/log/grafana
      - ./grafana/config.ini:/etc/grafana/grafana.ini:ro
      - ./grafana/provisioning:/etc/grafana/provisioning:ro
      - ./grafana/dashboards:/var/lib/grafana/dashboards:ro

  nginx:
    container_name: nginx
    image: nginx:1.29.2-alpine-slim
    ports:
      - 12001:3000
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
    secrets:
      - tls.crt
      - tls.key
    depends_on:
      - grafana
    
  elasticsearch:
    container_name: elasticsearch
    image: docker.elastic.co/elasticsearch/elasticsearch:9.1.5
    volumes:
      - es-data:/usr/share/elasticsearch

  fluentbit:
    container_name: fluentbit
    image: cr.fluentbit.io/fluent/fluent-bit:4.1.1
    command:
      - --config
      - /fluent-bit/etc/fluent-bit.yaml
    volumes:
      - ./fluentbit/fluent-bit.yaml:/fluent-bit/etc/fluent-bit.yaml:ro
      - fluentbit-db:/fluent-bit/db
      - fluentbit-logs:/fluent-bit/log
      - grafana-logs:/grafana/logs
    env_file:
      - ./fluentbit/.env
    depends_on:
      - elasticsearch

volumes:
  grafana-storage:
  grafana-logs:
  es-data:
  fluentbit-logs:
  fluentbit-db:
secrets:
  tls.crt:
    file: ./nginx/secrets/tls.crt
  tls.key:
    file: ./nginx/secrets/tls.key
