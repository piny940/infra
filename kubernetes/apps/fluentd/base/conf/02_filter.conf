<label @KUBERNETES>
  <match kubernetes.var.log.containers.fluentd**>
    @type relabel
    @label @FLUENT_LOG
  </match>

  <filter kubernetes.**>
    @type kubernetes_metadata
    @id filter_kube_metadata
    skip_labels false
    skip_container_metadata false
    skip_namespace_metadata true
    skip_master_url true
  </filter>

  <filter kubernetes.**>
    @type dedot
    de_dot true
    de_dot_separator "_"
    de_dot_nested true
  </filter>

  <filter kubernetes.**>
    @type parser
    key_name log
    reserve_data true
    <parse>
      @type multi_format
      format_key 'format'
      <pattern>
        format json
        format_name 'json'
      </pattern>
      <pattern>
        format none
        format_name 'text'
      </pattern>
    </parse>
  </filter>

  <match kubernetes.**>
    @type rewrite_tag_filter
    <rule>
      key $.kubernetes.namespace_name
      pattern ^(.+)$
      tag $1.${tag}
    </rule>
  </match>

  <match **>
    @type rewrite_tag_filter
    <rule>
      key format_name
      pattern ^(.+)$
      tag $1.${tag}
    </rule>
  </match>

  <match **>
    @type relabel
    @label @DISPATCH
  </match>
</label>
