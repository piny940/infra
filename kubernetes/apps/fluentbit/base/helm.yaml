apiVersion: source.toolkit.fluxcd.io/v1
kind: HelmRepository
metadata:
  name: fluent
spec:
  interval: 24h
  url: https://fluent.github.io/helm-charts
---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: fluent-bit
spec:
  interval: 3m
  chart:
    spec:
      chart: fluent-bit
      version: 0.54.0
      sourceRef:
        kind: HelmRepository
        name: fluent
  values:
    kind: DaemonSet
    args:
      - --workdir=/fluent-bit/etc
      - --config=/fluent-bit/etc/conf/fluent-bit.yaml
    serviceAccount:
      create: true
      name: fluent-bit
    serviceMonitor:
      enabled: true
      namespace: monitoring
      interval: 10s
      scrapeTimeout: 10s
      selector:
        release: kube-prometheus-stack
    prometheusRule:
      enabled: true
      namespace: "monitoring"
      rules:
        - alert: NoOutputBytesProcessed
          expr: rate(fluentbit_output_proc_bytes_total[5m]) == 0
          annotations:
            message: |
              Fluent Bit instance {{ $labels.instance }}'s output plugin {{ $labels.name }} has not processed any
              bytes for at least 15 minutes.
            summary: No Output Bytes Processed
          for: 10m
          labels:
            severity: critical
    livenessProbe:
      httpGet:
        path: /
        port: 2020
      initialDelaySeconds: 15
      periodSeconds: 10
    readinessProbe:
      httpGet:
        path: /api/v1/health
        port: 2020
      initialDelaySeconds: 5
      periodSeconds: 10
    resources:
      limits:
        cpu: 1000m
        memory: 1Gi
      requests:
        cpu: 20m
        memory: 128Mi
    ingress:
      enabled: false
    envFrom:
      - secretRef:
          name: fluentbit-secret
      - configMapRef:
          name: fluentbit-conf
    existingConfigMap: fluentbit-extra-files
  test:
    enable: false
