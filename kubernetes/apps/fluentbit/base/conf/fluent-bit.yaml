service:
  http_server: on
  http_listen: 0.0.0.0
  http_port: 2020
  health_check: on
  flush: 1
  log_level: info
parsers:
  - name: fluentbit_logs
    format: regex
    regex: '^\[(?<time>[^\]]+)\] \[(?<level>[^\]]*)\] \[(?<logger>[^\]]*)\] (?<msg>.*)$'
    time_key: time
    time_format: '%Y/%m/%d %H:%M:%S'
    time_keep: true
  - name: externaldns_logs
    format: regex
    regex: ^time="(?<time>[^"]+)" level=(?<level>\w+) msg="(?<msg>.*)"$
    time_key: time
    time_format: '%Y-%m-%dT%H:%M:%SZ'
    time_keep: true
  - name: json_with_time
    format: json
    time_key: time
    time_format: '%Y-%m-%dT%H:%M:%S'
    time_keep: true
pipeline:
  inputs:
    - name: tail
      path: /var/log/containers/*.log
      db: /var/log/fluent-bit.pos
      db.locking: true
      read_from_head: true
      multiline.parser: cri
      tag: kube.*
  filters:
    - name: kubernetes
      match: kube.*
      kube_tag_prefix: "kube.var.log.containers."
      merge_log: false
      keep_log: true
      labels: false
      annotations: false
    - name: parser
      match_regex: ^kube\.var\.log\.containers\.fluent-bit-[^-]+_monitoring_.*\.log$
      key_name: log
      parser: fluentbit_logs
      reserve_data: true
      preserve_key: true
    - name: parser
      match_regex: ^kube\.var\.log\.containers\.${PREFIX}auth-[^-]+-[^-]+_default_.*\.log$
      key_name: log
      parser: json_with_time
      reserve_data: true
      preserve_key: true
    - name: parser
      match_regex: ^kube\.var\.log\.containers\.${PREFIX}external-dns-[^-]+-[^-]+_default_.*\.log$
      key_name: log
      parser: externaldns_logs
      reserve_data: true
      preserve_key: true
    - name: parser
      match_regex: ^kube\.var\.log\.containers\.${PREFIX}k8s-status-badge-[^-]+-[^-]+_default_.*\.log$
      key_name: log
      parser: json_with_time
      reserve_data: true
      preserve_key: true
    - name: record_modifier
      match: "*"
      record:
        - env ${ENV}
  outputs:
    - match_regex: ^kube\.var\.log\.containers\.fluent-bit-[^-]+_monitoring_.*\.log$
      logstash_prefix: kubernetes.${ENV}.fluentbit.logs
      name: es
      compress: gzip
      host: ${ELASTICSEARCH_HOST}
      port: ${ELASTICSEARCH_PORT}
      tls: off
      http_user: ${ELASTICSEARCH_USER}
      http_passwd: '${ELASTICSEARCH_PASSWORD}'
      logstash_format: true
      logstash_prefix_separator: '-'
      logstash_dateformat: '%Y.%m.%d'
      time_key: '@timestamp'
      time_key_format: '%Y-%m-%dT%H:%M:%S'
      time_key_nanos: false
      include_tag_key: true
      tag_key: '_tag'
      suppress_type_name: true
      trace_error: true
    - match_regex: ^kube\.var\.log\.containers\.${PREFIX}auth-[^-]+-[^-]+_default_.*\.log$
      logstash_prefix: kubernetes.${ENV}.auth.logs
      name: es
      compress: gzip
      host: ${ELASTICSEARCH_HOST}
      port: ${ELASTICSEARCH_PORT}
      tls: off
      http_user: ${ELASTICSEARCH_USER}
      http_passwd: '${ELASTICSEARCH_PASSWORD}'
      logstash_format: true
      logstash_prefix_separator: '-'
      logstash_dateformat: '%Y.%m.%d'
      time_key: '@timestamp'
      time_key_format: '%Y-%m-%dT%H:%M:%S'
      time_key_nanos: false
      include_tag_key: true
      tag_key: '_tag'
      suppress_type_name: true
      trace_error: true
    - match_regex: ^kube\.var\.log\.containers\.${PREFIX}auth-frontend-[^-]+-[^-]+_default_.*\.log$
      logstash_prefix: kubernetes.${ENV}.auth-frontend.logs
      name: es
      compress: gzip
      host: ${ELASTICSEARCH_HOST}
      port: ${ELASTICSEARCH_PORT}
      tls: off
      http_user: ${ELASTICSEARCH_USER}
      http_passwd: '${ELASTICSEARCH_PASSWORD}'
      logstash_format: true
      logstash_prefix_separator: '-'
      logstash_dateformat: '%Y.%m.%d'
      time_key: '@timestamp'
      time_key_format: '%Y-%m-%dT%H:%M:%S'
      time_key_nanos: false
      include_tag_key: true
      tag_key: '_tag'
      suppress_type_name: true
      trace_error: true
    - match_regex: ^kube\.var\.log\.containers\.${PREFIX}auth-example-[^-]+-[^-]+_default_.*\.log$
      logstash_prefix: kubernetes.${ENV}.auth-example.logs
      name: es
      compress: gzip
      host: ${ELASTICSEARCH_HOST}
      port: ${ELASTICSEARCH_PORT}
      tls: off
      http_user: ${ELASTICSEARCH_USER}
      http_passwd: '${ELASTICSEARCH_PASSWORD}'
      logstash_format: true
      logstash_prefix_separator: '-'
      logstash_dateformat: '%Y.%m.%d'
      time_key: '@timestamp'
      time_key_format: '%Y-%m-%dT%H:%M:%S'
      time_key_nanos: false
      include_tag_key: true
      tag_key: '_tag'
      suppress_type_name: true
      trace_error: true
    - match_regex: ^kube\.var\.log\.containers\.${PREFIX}external-dns-[^-]+-[^-]+_default_.*\.log$
      logstash_prefix: kubernetes.${ENV}.external-dns.logs
      name: es
      compress: gzip
      host: ${ELASTICSEARCH_HOST}
      port: ${ELASTICSEARCH_PORT}
      tls: off
      http_user: ${ELASTICSEARCH_USER}
      http_passwd: '${ELASTICSEARCH_PASSWORD}'
      logstash_format: true
      logstash_prefix_separator: '-'
      logstash_dateformat: '%Y.%m.%d'
      time_key: '@timestamp'
      time_key_format: '%Y-%m-%dT%H:%M:%S'
      time_key_nanos: false
      include_tag_key: true
      tag_key: '_tag'
      suppress_type_name: true
      trace_error: true
    - match_regex: ^kube\.var\.log\.containers\.${PREFIX}k8s-status-badge-[^-]+-[^-]+_default_.*\.log$
      logstash_prefix: kubernetes.${ENV}.k8s-status-badge.logs
      name: es
      compress: gzip
      host: ${ELASTICSEARCH_HOST}
      port: ${ELASTICSEARCH_PORT}
      tls: off
      http_user: ${ELASTICSEARCH_USER}
      http_passwd: '${ELASTICSEARCH_PASSWORD}'
      logstash_format: true
      logstash_prefix_separator: '-'
      logstash_dateformat: '%Y.%m.%d'
      time_key: '@timestamp'
      time_key_format: '%Y-%m-%dT%H:%M:%S'
      time_key_nanos: false
      include_tag_key: true
      tag_key: '_tag'
      suppress_type_name: true
      trace_error: true
