service:
  http_server: on
  http_listen: 0.0.0.0
  http_port: 2020
  health_check: on
  flush: 1
  log_level: info
parsers:
  - name: fluentbit_logs
    format: regex
    regex: '^\[(?<time>[^\]]+)\] \[(?<level>[^\]]*)\] \[(?<logger>[^\]]*)\] (?<msg>.*)$'
    time_key: time
    time_format: '%Y/%m/%d %H:%M:%S'
    time_keep: true
  - name: json_with_time
    format: json
    time_key: time
    time_format: '%Y-%m-%dT%H:%M:%S'
    time_keep: true
pipeline:
  inputs:
    - tag: kubernetes.fluentbit.*
      name: tail
      path: /var/log/containers/fluent-bit-*_monitoring_*.log
      db: /var/log/fluent-bit-monitoring.pos
      db.locking: true
      read_from_head: true
      multiline.parser: cri
    - tag: kubernetes.auth.*
      name: tail
      path: /var/log/containers/${PREFIX}auth-*_default_*.log
      exclude_path: /var/log/containers/${PREFIX}auth-frontend-*.log,/var/log/containers/${PREFIX}auth-example-*.log
      db: /var/log/fluent-bit-auth.pos
      db.locking: true
      read_from_head: true
      multiline.parser: cri
    - tag: kubernetes.auth-frontend.*
      name: tail
      path: /var/log/containers/${PREFIX}auth-frontend-*_default_*.log
      db: /var/log/fluent-bit-auth-frontend.pos
      db.locking: true
      read_from_head: true
      multiline.parser: cri
    - tag: kubernetes.auth-example.*
      name: tail
      path: /var/log/containers/${PREFIX}auth-example-*_default_*.log
      db: /var/log/fluent-bit-auth-example.pos
      db.locking: true
      read_from_head: true
      multiline.parser: cri
  filters:
    - name: parser
      match: kubernetes.fluentbit.*
      key_name: log
      parser: fluentbit_logs
      reserve_data: true
    - name: parser
      match: kubernetes.auth.*
      key_name: log
      parser: json_with_time
      reserve_data: true
    - name: kubernetes
      match: kubernetes.*
      merge_log: true
      keep_log: false
      labels: false
      annotations: false
  outputs:
    - match: 'kubernetes.fluentbit.*'
      name: es
      compress: gzip
      host: ${ELASTICSEARCH_HOST}
      port: ${ELASTICSEARCH_PORT}
      tls: off
      http_user: ${ELASTICSEARCH_USER}
      http_passwd: '${ELASTICSEARCH_PASSWORD}'
      logstash_format: true
      logstash_prefix: kubernetes.${ENV}.fluentbit.logs
      logstash_prefix_separator: '-'
      logstash_dateformat: '%Y.%m.%d'
      time_key: '@timestamp'
      time_key_format: '%Y-%m-%dT%H:%M:%S'
      time_key_nanos: false
      include_tag_key: true
      tag_key: '_tag'
      suppress_type_name: true
      trace_error: true
    - match: 'kubernetes.auth.*'
      logstash_prefix: kubernetes.${ENV}.auth.logs
      name: es
      compress: gzip
      host: ${ELASTICSEARCH_HOST}
      port: ${ELASTICSEARCH_PORT}
      tls: off
      http_user: ${ELASTICSEARCH_USER}
      http_passwd: '${ELASTICSEARCH_PASSWORD}'
      logstash_format: true
      logstash_prefix_separator: '-'
      logstash_dateformat: '%Y.%m.%d'
      time_key: '@timestamp'
      time_key_format: '%Y-%m-%dT%H:%M:%S'
      time_key_nanos: false
      include_tag_key: true
      tag_key: '_tag'
      suppress_type_name: true
      trace_error: true
    - match: 'kubernetes.auth-frontend.*'
      logstash_prefix: kubernetes.${ENV}.auth-frontend.logs
      name: es
      compress: gzip
      host: ${ELASTICSEARCH_HOST}
      port: ${ELASTICSEARCH_PORT}
      tls: off
      http_user: ${ELASTICSEARCH_USER}
      http_passwd: '${ELASTICSEARCH_PASSWORD}'
      logstash_format: true
      logstash_prefix_separator: '-'
      logstash_dateformat: '%Y.%m.%d'
      time_key: '@timestamp'
      time_key_format: '%Y-%m-%dT%H:%M:%S'
      time_key_nanos: false
      include_tag_key: true
      tag_key: '_tag'
      suppress_type_name: true
      trace_error: true
    - match: 'kubernetes.auth-example.*'
      logstash_prefix: kubernetes.${ENV}.auth-example.logs
      name: es
      compress: gzip
      host: ${ELASTICSEARCH_HOST}
      port: ${ELASTICSEARCH_PORT}
      tls: off
      http_user: ${ELASTICSEARCH_USER}
      http_passwd: '${ELASTICSEARCH_PASSWORD}'
      logstash_format: true
      logstash_prefix_separator: '-'
      logstash_dateformat: '%Y.%m.%d'
      time_key: '@timestamp'
      time_key_format: '%Y-%m-%dT%H:%M:%S'
      time_key_nanos: false
      include_tag_key: true
      tag_key: '_tag'
      suppress_type_name: true
      trace_error: true
