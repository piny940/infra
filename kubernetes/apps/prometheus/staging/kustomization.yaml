apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
namespace: monitoring
commonLabels:
  env: staging
resources:
  - ../base
patches:
  - path: helm.yaml
configMapGenerator:
  - name: prometheus-oauth2-proxy-conf
    behavior: merge
    literals:
      - PROMETHEUS_FQDN=stg-prometheus.piny940.com
      - ALERTMANAGER_FQDN=stg-alertmanager.piny940.com
replacements:
  - source:
      kind: ConfigMap
      version: v1
      name: prometheus-oauth2-proxy-conf
      fieldPath: data.ALERTMANAGER_FQDN
    targets:
      - select:
          group: helm.toolkit.fluxcd.io
          version: v2
          kind: HelmRelease
          name: kube-prometheus-stack
        fieldPaths:
          - spec.values.alertmanager.ingress.hosts.0
          - spec.values.alertmanager.ingress.tls.0.hosts.0
      - select:
          group: helm.toolkit.fluxcd.io
          version: v2
          kind: HelmRelease
          name: alertmanager-oauth2-proxy
        fieldPaths:
          - spec.values.ingress.hosts.0
          - spec.values.ingress.tls.0.hosts.0
  - source:
      kind: ConfigMap
      version: v1
      name: prometheus-oauth2-proxy-conf
      fieldPath: data.PROMETHEUS_FQDN
    targets:
      - select:
          group: helm.toolkit.fluxcd.io
          version: v2
          kind: HelmRelease
          name: kube-prometheus-stack
        fieldPaths:
          - spec.values.prometheus.ingress.hosts.0
          - spec.values.prometheus.ingress.tls.0.hosts.0
      - select:
          group: helm.toolkit.fluxcd.io
          version: v2
          kind: HelmRelease
          name: prometheus-oauth2-proxy
        fieldPaths:
          - spec.values.ingress.hosts.0
          - spec.values.ingress.tls.0.hosts.0
